<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f3f4f6;
            --border: #d1d5db;
            --text: #1f2937;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text);
        }

        /* Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ø¹Ø±Ø¶ */
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            padding: 30px;
            position: relative;
            min-height: 80vh;
        }
        
        .hidden { display: none !important; }

        /* --- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ù„Ù„Ù…Ø¯ÙŠØ±) --- */
        .top-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            align-items: center;
            flex-wrap: wrap;
        }

        /* --- Ø§Ù„Ø¨Ø­Ø« --- */
        .search-wrapper {
            flex: 2;
            position: relative;
            min-width: 300px;
        }
        .search-input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }
        .search-input:focus { border-color: var(--primary); }
        .search-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: 0 0 6px 6px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        .search-results div {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }
        .search-results div:hover { background-color: #eff6ff; }
        
        /* --- Ø§Ù„Ø£Ø²Ø±Ø§Ø± --- */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-outline { background: white; border: 1px solid #cbd5e1; color: #475569; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* --- ØªÙ†Ø³ÙŠÙ‚ Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠØ± --- */
        .grid-form { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-top: 20px;
        }
        .form-group { display: flex; flex-direction: column; transition: all 0.3s ease; }
        .editable-label { 
            font-weight: bold; margin-bottom: 6px; font-size: 0.9rem; color: #374151; cursor: text; width: fit-content;
            border-bottom: 1px dashed transparent;
        }
        .editable-label:hover { border-bottom-color: #9ca3af; color: var(--primary); }
        .editable-label[data-custom="true"]::after { content: " *"; color: #f59e0b; }
        
        .form-group input, .form-group select, .form-group textarea {
            padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; width: 100%; box-sizing: border-box;
        }
        textarea { resize: vertical; min-height: 80px; }

        /* --- ØªÙ†Ø³ÙŠÙ‚ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠØ©) --- */
        .user-view-container {
            max-width: 700px;
            margin: 0 auto;
        }
        .info-sheet {
            border: 1px solid #e2e8f0;
            padding: 40px;
            background: white;
            margin-top: 20px;
            border-radius: 8px;
        }
        .sheet-header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .info-row {
            display: flex;
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .info-label {
            font-weight: bold;
            width: 35%;
            color: #444;
        }
        .info-value {
            width: 65%;
            color: #000;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #f3f4f6; display: flex; justify-content: center; 
            align-items: center; z-index: 2000; 
        }
        .login-box { 
            background: white; padding: 40px; border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 350px; 
        }

        #notification {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 12px 25px; border-radius: 50px; color: white; 
            transition: 0.3s; opacity: 0; pointer-events: none; z-index: 3000;
        }

        /* ========================================= */
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        /* ========================================= */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white; padding: 0; margin: 0; -webkit-print-color-adjust: exact; }
            
            .no-print, .top-toolbar, #login-screen, #notification, .btn, .search-wrapper { display: none !important; }

            .container {
                box-shadow: none; margin: 0; padding: 0; width: 100%; max-width: 100%; border: none; min-height: auto;
            }

            /* Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (Ø´Ø¨ÙƒØ©) */
            .grid-form { 
                display: grid !important; grid-template-columns: 1fr 1fr; column-gap: 40px; row-gap: 10px;
            }
            .form-group { break-inside: avoid; margin-bottom: 5px; }
            .form-group input, .form-group select, .form-group textarea { 
                border: none !important; border-bottom: 1px dotted #000 !important;
                background: transparent !important; padding: 0 0 5px 0 !important;
            }
            .editable-label[data-custom="true"]::after { content: ""; }

            /* Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙˆØ±Ù‚Ø©) */
            .info-sheet {
                border: none; padding: 0; margin: 0;
            }
            .info-row {
                border-bottom: 1px dotted #999;
                padding: 8px 0;
            }
        }
    </style>
</head>
<body>

    <div id="notification"></div>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-top: 0;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <form onsubmit="handleLogin(event)">
                <input type="password" id="login-code" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„" required style="width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;">
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">Ø¯Ø®ÙˆÙ„</button>
            </form>
            <p style="font-size: 0.8rem; margin-top: 15px; color: #666;">Ø§Ù„Ù…Ø¯ÙŠØ±: 110011 | Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: 122</p>
        </div>
    </div>

    <div class="container hidden" id="main-container">
        
        <div id="admin-interface" class="hidden">
            <div class="top-toolbar no-print">
                <div class="search-wrapper">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="admin-search" class="search-input" placeholder="Ø¨Ø­Ø« Ø¥Ø¯Ø§Ø±ÙŠ ÙˆØªØ¹Ø¯ÙŠÙ„..." oninput="handleSearch(this.value, 'admin')" autocomplete="off">
                    <div id="admin-search-results" class="search-results"></div>
                </div>

                <button onclick="window.print()" class="btn btn-outline">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                <button onclick="triggerImport()" class="btn btn-warning">ğŸ“‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
                <input type="file" id="file-import" accept=".json" style="display: none;" onchange="importJSON(this)">
                <button onclick="addNewField()" class="btn btn-success">â• Ø­Ù‚Ù„ Ø¬Ø¯ÙŠØ¯</button>
                <div style="flex-grow: 1;"></div> 
                <button onclick="resetAdminForm()" class="btn btn-outline">Ø¬Ø¯ÙŠØ¯</button>
                <button onclick="saveForm()" class="btn btn-primary" id="save-btn">ğŸ’¾ Ø­ÙØ¸</button>
                <button onclick="exportJSON()" class="btn btn-success">â¬‡ï¸ Backup</button>
                <button onclick="handleLogout()" class="btn btn-danger">Ø®Ø±ÙˆØ¬</button>
            </div>

            <form id="admin-form" onsubmit="event.preventDefault();">
                <input type="hidden" id="f_id"> 
                <div class="grid-form" id="form-container">
                    <div class="form-group"><label id="lbl_name" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ ÙˆØ§Ù„Ù„Ù‚Ø¨</label><input type="text" id="f_name"></div>
                    <div class="form-group"><label id="lbl_dob" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input type="date" id="f_dob"></div>
                    <div class="form-group"><label id="lbl_pob" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ù…Ø­Ù„ Ø§Ù„ØªÙˆÙ„Ø¯</label><input type="text" id="f_pob"></div>
                    <div class="form-group"><label id="lbl_gender" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø§Ù„Ø¬Ù†Ø³</label><select id="f_gender"><option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option><option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option></select></div>
                    <div class="form-group"><label id="lbl_mother" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø§Ø³Ù… Ø§Ù„Ø£Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label><input type="text" id="f_mother"></div>
                    <div class="form-group"><label id="lbl_national" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label><input type="text" id="f_national_id"></div>
                    <div class="form-group"><label id="lbl_marital" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø²ÙˆØ¬ÙŠØ©</label><select id="f_marital" onchange="toggleMaritalFields()"><option value="Ø£Ø¹Ø²Ø¨">Ø£Ø¹Ø²Ø¨</option><option value="Ù…ØªØ²ÙˆØ¬">Ù…ØªØ²ÙˆØ¬</option><option value="Ù…Ø·Ù„Ù‚">Ù…Ø·Ù„Ù‚</option><option value="Ø£Ø±Ù…Ù„">Ø£Ø±Ù…Ù„</option></select></div>
                    <div class="form-group hidden" id="group-spouse"><label id="lbl_spouse" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬/Ø§Ù„Ø²ÙˆØ¬Ø©</label><input type="text" id="f_spouse"></div>
                    <div class="form-group hidden" id="group-children"><label id="lbl_children" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø·ÙØ§Ù„</label><input type="number" id="f_children"></div>
                    <div class="form-group"><label id="lbl_edu" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label><input type="text" id="f_education"></div>
                    <div class="form-group"><label id="lbl_spec" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label><input type="text" id="f_specialization"></div>
                    <div class="form-group"><label id="lbl_job" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</label><input type="text" id="f_job"></div>
                    <div class="form-group"><label id="lbl_phone" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" id="f_phone"></div>
                    <div class="form-group"><label id="lbl_address1" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©/Ø§Ù„Ù‚Ø¶Ø§Ø¡)</label><input type="text" id="f_address_1"></div>
                    <div class="form-group"><label id="lbl_address2" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="f_address_2"></div>
                    <div class="form-group"><label id="lbl_landmark" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø£Ù‚Ø±Ø¨ Ù†Ù‚Ø·Ø© Ø¯Ø§Ù„Ø©</label><input type="text" id="f_landmark"></div>
                    <div class="form-group"><label id="lbl_org" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø§Ù„Ù‡ÙŠØ¦Ø©</label><input type="text" id="f_org_body"></div>
                    <div class="form-group"><label id="lbl_branch" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø§Ù„ÙØ±Ø¹</label><select id="f_org_branch"><option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹...</option><option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„</option><option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù„Ø«">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù„Ø«</option><option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø¹">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø¹</option><option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø®Ø§Ù…Ø³">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø®Ø§Ù…Ø³</option><option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø¯Ø³">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø¯Ø³</option><option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option></select></div>
                    <div class="form-group"><label id="lbl_div" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø§Ù„Ø´Ø¹Ø¨Ø©</label><input type="text" id="f_org_div"></div>
                    <div class="form-group"><label id="lbl_div_name" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©</label><input type="text" id="f_org_div_name"></div>
                    <div class="form-group"><label id="lbl_skills" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø§Ù„Ø®Ø¨Ø±Ø§Øª</label><textarea id="f_skills"></textarea></div>
                    <div class="form-group"><label id="lbl_ref" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ø§Ù„Ù…Ø¹Ø±Ù</label><input type="text" id="f_ref_name"></div>
                    
                    <div id="dynamic-fields-area" style="display: contents;"></div>

                    <div class="form-group" style="grid-column: 1 / -1;"><label id="lbl_notes" class="editable-label" contenteditable="true" onblur="saveLabel(this.id)">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="f_notes"></textarea></div>
                </div>
            </form>
        </div>

        <div id="user-interface" class="hidden">
            <div class="user-view-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;" class="no-print">
                    <h2 style="margin: 0; color: var(--primary);">Ø¨Ø­Ø« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
                    <button onclick="handleLogout()" class="btn btn-danger">Ø®Ø±ÙˆØ¬</button>
                </div>

                <div class="search-wrapper no-print">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" class="search-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø¨Ø­Ø«..." oninput="handleSearch(this.value, 'user')">
                    <div id="user-search-results" class="search-results"></div>
                </div>

                <div id="user-sheet-view" class="hidden">
                    <div style="text-align: left; margin: 20px 0;" class="no-print">
                        <button onclick="window.print()" class="btn btn-primary">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØ±Ù‚Ø©</button>
                        <button onclick="closeUserSheet()" class="btn btn-outline">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>

                    <div class="info-sheet">
                        <div class="sheet-header">
                            <h3>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>
                            <p id="sheet-date" style="font-size: 0.8rem; color: #666;"></p>
                        </div>
                        <div id="sheet-content">
                            </div>
                    </div>
                </div>
                
                <div id="user-placeholder" style="text-align: center; margin-top: 50px; color: #999;" class="no-print">
                    <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        const DB_KEY = 'unified_form_db_v4';
        let appData = {
            records: [],
            labels: {},
            customFields: [] 
        };
        let currentRole = '';

        window.onload = function() {
            loadData();
            loadLabels();
            renderCustomFields();
            
            const savedRole = sessionStorage.getItem('user_role');
            if (savedRole) {
                loginSuccess(savedRole);
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        };

        function loadData() {
            const stored = localStorage.getItem(DB_KEY);
            if (stored) {
                appData = JSON.parse(stored);
                if (!appData.records) appData.records = [];
                if (!appData.labels) appData.labels = {};
                if (!appData.customFields) appData.customFields = [];
            }
        }

        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(appData));
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
        function handleLogin(e) {
            e.preventDefault();
            const code = document.getElementById('login-code').value;
            
            if (code === '110011') {
                loginSuccess('ADMIN');
            } else if (code === '122') {
                loginSuccess('USER');
            } else {
                alert('Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­');
            }
        }

        function loginSuccess(role) {
            currentRole = role;
            sessionStorage.setItem('user_role', role);
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-container').classList.remove('hidden');

            if (role === 'ADMIN') {
                document.getElementById('admin-interface').classList.remove('hidden');
                document.getElementById('user-interface').classList.add('hidden');
            } else {
                document.getElementById('user-interface').classList.remove('hidden');
                document.getElementById('admin-interface').classList.add('hidden');
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('user_role');
            location.reload();
        }

        // --- Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø´ØªØ±Ùƒ ---
        function handleSearch(val, context) {
            const dropdownId = context === 'admin' ? 'admin-search-results' : 'user-search-results';
            const dropdown = document.getElementById(dropdownId);
            dropdown.innerHTML = '';
            
            if (!val || val.length < 1) {
                dropdown.style.display = 'none';
                return;
            }

            const matches = appData.records.filter(r => 
                (r.name && r.name.includes(val)) || 
                (r.phone && r.phone.includes(val))
            );

            if (matches.length > 0) {
                matches.forEach(r => {
                    const div = document.createElement('div');
                    div.innerHTML = `<strong>${r.name}</strong>`;
                    div.onclick = () => {
                        if (context === 'admin') loadAdminRecord(r);
                        else loadUserSheet(r);
                        dropdown.style.display = 'none';
                        if(context === 'user') document.querySelector('#user-interface .search-input').value = '';
                        else document.querySelector('#admin-interface .search-input').value = '';
                    };
                    dropdown.appendChild(div);
                });
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø¯ÙŠØ± (ADMIN) ---
        function addNewField() {
            const fieldId = 'custom_' + Date.now();
            const newField = { id: fieldId, label: 'Ø­Ù‚Ù„ Ø¬Ø¯ÙŠØ¯' };
            appData.customFields.push(newField);
            saveData();
            appendFieldToDOM(newField);
            showNotify('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù‚Ù„', 'success');
        }

        function appendFieldToDOM(fieldObj) {
            const container = document.getElementById('dynamic-fields-area');
            const div = document.createElement('div');
            div.className = 'form-group';
            div.id = 'group_' + fieldObj.id;
            div.innerHTML = `
                <label id="lbl_${fieldObj.id}" class="editable-label" contenteditable="true" data-custom="true" onblur="saveLabel(this.id)">${fieldObj.label}</label>
                <input type="text" id="${fieldObj.id}">
            `;
            container.appendChild(div);
        }

        function renderCustomFields() {
            const container = document.getElementById('dynamic-fields-area');
            container.innerHTML = '';
            appData.customFields.forEach(field => {
                const savedLabel = appData.labels['lbl_' + field.id] || field.label;
                appendFieldToDOM({ id: field.id, label: savedLabel });
            });
        }

        function saveLabel(elementId) {
            const el = document.getElementById(elementId);
            const text = el.innerText.trim();
            const isCustom = el.getAttribute('data-custom') === 'true';

            if (text === '' && isCustom) {
                const fieldId = elementId.replace('lbl_', '');
                if(confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
                    appData.customFields = appData.customFields.filter(f => f.id !== fieldId);
                    delete appData.labels[elementId];
                    saveData();
                    document.getElementById('group_' + fieldId).remove();
                    showNotify('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'error');
                } else {
                    el.innerText = appData.labels[elementId] || 'Ø­Ù‚Ù„ Ø¬Ø¯ÙŠØ¯';
                }
                return;
            }
            appData.labels[elementId] = text;
            saveData();
        }

        function loadLabels() {
            for (const [id, text] of Object.entries(appData.labels)) {
                const el = document.getElementById(id);
                if (el) el.innerText = text;
            }
        }

        function loadAdminRecord(record) {
            document.getElementById('f_id').value = record.id;
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            const fields = ['name', 'dob', 'pob', 'gender', 'mother', 'national_id', 'marital', 'spouse', 'children', 'education', 'specialization', 'job', 'phone', 'address_1', 'address_2', 'landmark', 'org_body', 'org_branch', 'org_div', 'org_div_name', 'skills', 'ref_name', 'notes'];
            fields.forEach(f => {
                if(document.getElementById('f_'+f)) document.getElementById('f_'+f).value = record[f] || '';
            });

            toggleMaritalFields();

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¶Ø§ÙØ©
            appData.customFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (input) input.value = (record.customData && record.customData[field.id]) ? record.customData[field.id] : '';
            });

            const btn = document.getElementById('save-btn');
            btn.textContent = 'ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­ÙØ¸';
            btn.classList.replace('btn-primary', 'btn-success');
        }

        function saveForm() {
            const idVal = document.getElementById('f_id').value;
            const nameVal = document.getElementById('f_name').value;
            if(!nameVal) { alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…'); return; }

            let customDataObj = {};
            appData.customFields.forEach(field => {
                const el = document.getElementById(field.id);
                if(el) customDataObj[field.id] = el.value;
            });

            const record = {
                id: idVal ? parseInt(idVal) : Date.now(),
                customData: customDataObj
            };
            
            // Ø¬Ù…Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            const fields = ['name', 'dob', 'pob', 'gender', 'mother', 'national_id', 'marital', 'spouse', 'children', 'education', 'specialization', 'job', 'phone', 'address_1', 'address_2', 'landmark', 'org_body', 'org_branch', 'org_div', 'org_div_name', 'skills', 'ref_name', 'notes'];
            fields.forEach(f => {
                const el = document.getElementById('f_'+f);
                if(el) record[f] = el.value;
            });

            if (idVal) {
                const index = appData.records.findIndex(r => r.id == idVal);
                if (index !== -1) appData.records[index] = record;
            } else {
                appData.records.push(record);
            }

            saveData();
            showNotify('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            if(!idVal) resetAdminForm();
        }

        function resetAdminForm() {
            document.getElementById('admin-form').reset();
            document.getElementById('f_id').value = '';
            document.getElementById('save-btn').textContent = 'ğŸ’¾ Ø­ÙØ¸';
            document.getElementById('save-btn').classList.remove('btn-success');
            document.getElementById('save-btn').classList.add('btn-primary');
            toggleMaritalFields();
        }

        function toggleMaritalFields() {
            const status = document.getElementById('f_marital').value;
            const isMarried = status === 'Ù…ØªØ²ÙˆØ¬';
            document.getElementById('group-spouse').classList.toggle('hidden', !isMarried);
            document.getElementById('group-children').classList.toggle('hidden', !isMarried);
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (USER) ---
        function loadUserSheet(record) {
            document.getElementById('user-placeholder').classList.add('hidden');
            document.getElementById('user-sheet-view').classList.remove('hidden');
            
            const content = document.getElementById('sheet-content');
            document.getElementById('sheet-date').textContent = new Date().toLocaleDateString('ar-IQ');
            content.innerHTML = '';

            // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¬Ù„Ø¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ù‚Ù„ (Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø£Ùˆ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)
            const getLabel = (id, defaultTxt) => appData.labels[id] || defaultTxt;

            // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„ÙˆØ±Ù‚Ø©
            const fieldsMap = [
                { k: 'name', id: 'lbl_name', def: 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ' },
                { k: 'dob', id: 'lbl_dob', def: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯' },
                { k: 'gender', id: 'lbl_gender', def: 'Ø§Ù„Ø¬Ù†Ø³' },
                { k: 'phone', id: 'lbl_phone', def: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ' },
                { k: 'job', id: 'lbl_job', def: 'Ø§Ù„Ø¹Ù…Ù„' },
                { k: 'address_1', id: 'lbl_address1', def: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†' },
                { k: 'org_branch', id: 'lbl_branch', def: 'Ø§Ù„ÙØ±Ø¹' },
                { k: 'org_div_name', id: 'lbl_div_name', def: 'Ø§Ù„Ø´Ø¹Ø¨Ø©' },
                { k: 'notes', id: 'lbl_notes', def: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª' }
            ];

            // Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            fieldsMap.forEach(item => {
                if(record[item.k]) {
                    const row = `
                        <div class="info-row">
                            <div class="info-label">${getLabel(item.id, item.def)}</div>
                            <div class="info-value">${record[item.k]}</div>
                        </div>`;
                    content.innerHTML += row;
                }
            });

            // Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¶Ø§ÙØ© (Custom Fields)
            if(record.customData) {
                appData.customFields.forEach(field => {
                    const val = record.customData[field.id];
                    if(val) {
                        const lbl = appData.labels['lbl_' + field.id] || field.label;
                        const row = `
                            <div class="info-row">
                                <div class="info-label">${lbl}</div>
                                <div class="info-value">${val}</div>
                            </div>`;
                        content.innerHTML += row;
                    }
                });
            }
        }

        function closeUserSheet() {
            document.getElementById('user-sheet-view').classList.add('hidden');
            document.getElementById('user-placeholder').classList.remove('hidden');
        }

        // --- Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© ---
        function exportJSON() {
            const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function triggerImport() { document.getElementById('file-import').click(); }

        function importJSON(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if(imported.records) appData.records = imported.records;
                    if(imported.labels) appData.labels = imported.labels;
                    if(imported.customFields) appData.customFields = imported.customFields;
                    saveData();
                    loadLabels();
                    renderCustomFields();
                    showNotify('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'success');
                } catch (err) { alert('Ù…Ù„Ù Ø®Ø·Ø£'); }
            };
            reader.readAsText(file);
        }

        function showNotify(msg, type) {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.style.background = type === 'success' ? '#10b981' : '#ef4444';
            n.style.opacity = '1';
            setTimeout(() => { n.style.opacity = '0'; }, 3000);
        }
    </script>
</body>
</html>

