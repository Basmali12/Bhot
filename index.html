
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f3f4f6;
            --surface: #ffffff;
            --text: #1f2937;
            --border: #d1d5db;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; }
        
        /* Utils */
        .hidden { display: none !important; }
        .btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { border: 1px solid var(--border); background: white; color: var(--text); }
        .full-width { width: 100%; }
        
        /* Login Screen */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-box { background: var(--surface); padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); width: 90%; max-width: 350px; text-align: center; }
        .login-box input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid var(--border); border-radius: 6px; font-size: 16px; text-align: center; letter-spacing: 2px; }

        /* Layout */
        header { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .container { padding: 15px; max-width: 1200px; margin: 0 auto; }

        /* Navigation Tabs */
        .tabs { display: flex; gap: 5px; background: white; padding: 5px; border-radius: 8px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; cursor: pointer; border-radius: 6px; white-space: nowrap; font-weight: bold; color: #6b7280; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* Forms */
        .form-section { background: var(--surface); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border); }
        .form-section h3 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; font-size: 1.1rem; }
        .grid-form { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        @media (max-width: 600px) { .grid-form { grid-template-columns: 1fr; } }
        
        .form-group { margin-bottom: 5px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; background: #fff; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        
        /* Table */
        .table-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; background: white; padding: 10px; border-radius: 8px; }
        .table-responsive { overflow-x: auto; background: var(--surface); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        th { background: #f9fafb; font-weight: 600; color: #374151; }
        tr:hover { background: #f9fafb; }
        
        /* Notifications */
        #notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 50px; color: white; font-weight: bold; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 2000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .notify-success { background: var(--success); }
        .notify-error { background: var(--danger); }

        /* Print Styles - Vertical Layout */
        @media print {
            body { background: white; padding: 0; font-size: 12pt; }
            header, .tabs, .table-controls, #login-screen, .no-print { display: none !important; }
            .container { max-width: 100%; width: 100%; padding: 0; margin: 0; }
            
            /* Hide sections borders for cleaner look */
            .form-section { border: none; padding: 0; margin-bottom: 10px; box-shadow: none; page-break-inside: avoid; }
            .form-section h3 { border-bottom: 1px solid #000; color: #000; font-size: 14pt; margin-bottom: 10px; }
            
            /* Force Vertical Stack */
            .grid-form { display: block !important; }
            .form-group { 
                display: flex; 
                margin-bottom: 8px; 
                border-bottom: 1px dotted #ccc;
                padding-bottom: 4px;
            }
            .form-group label { 
                width: 180px; 
                font-weight: bold; 
                color: #000;
                flex-shrink: 0;
            }
            .form-group input, .form-group select, .form-group textarea { 
                border: none !important; 
                background: transparent !important; 
                padding: 0 !important; 
                font-weight: normal;
                color: #000;
                flex-grow: 1;
                font-family: inherit;
                resize: none;
            }
            
            /* Hide placeholders in print */
            ::placeholder { color: transparent; }
            
            /* Ensure single page fit mostly */
            .tab-content { display: block !important; }
        }
    </style>
</head>
<body>

    <div id="notification"></div>

    <div id="login-screen">
        <div class="login-box">
            <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <p style="color: #666; font-size: 0.9rem;">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            <form onsubmit="handleLogin(event)">
                <input type="password" id="login-code" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„" required autocomplete="off">
                <button type="submit" class="btn btn-primary full-width">Ø¯Ø®ÙˆÙ„</button>
            </form>
        </div>
    </div>

    <div id="app-interface" class="hidden">
        <header>
            <div id="app-title">Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="user-role-display" style="font-size: 0.8rem; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px;"></span>
                <button onclick="handleLogout()" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <div class="container">
            <div class="tabs no-print">
                <button class="tab-btn admin-only" id="btn-tab-form" onclick="switchTab('tab-form')">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="tab-btn" id="btn-tab-db" onclick="switchTab('tab-db')">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø­Ø«</button>
                <button class="tab-btn admin-only" id="btn-tab-settings" onclick="switchTab('tab-settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>

            <div id="tab-form" class="tab-content hidden">
                <form id="main-form" onsubmit="handleSave(event)">
                    <input type="hidden" id="f_id"> 
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;" class="no-print admin-only">
                        <button type="button" class="btn btn-outline" onclick="resetForm()">Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ø¬Ø¯ÙŠØ¯)</button>
                        <button type="submit" class="btn btn-primary" id="save-btn">Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</button>
                    </div>

                    <div class="form-section">
                        <h3>1. Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>
                        <div class="grid-form">
                            <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ ÙˆØ§Ù„Ù„Ù‚Ø¨</label><input type="text" id="f_name" required></div>
                            <div class="form-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input type="date" id="f_dob"></div>
                            <div class="form-group"><label>Ù…Ø­Ù„ Ø§Ù„ØªÙˆÙ„Ø¯</label><input type="text" id="f_pob"></div>
                            <div class="form-group"><label>Ø§Ù„Ø¬Ù†Ø³</label>
                                <select id="f_gender">
                                    <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
                                    <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ø£Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label><input type="text" id="f_mother"></div>
                            <div class="form-group"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label><input type="text" id="f_national_id"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>2. Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</h3>
                        <div class="grid-form">
                            <div class="form-group">
                                <label>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø²ÙˆØ¬ÙŠØ©</label>
                                <select id="f_marital" onchange="toggleMaritalFields()">
                                    <option value="Ø£Ø¹Ø²Ø¨">Ø£Ø¹Ø²Ø¨</option>
                                    <option value="Ù…ØªØ²ÙˆØ¬">Ù…ØªØ²ÙˆØ¬</option>
                                    <option value="Ù…Ø·Ù„Ù‚">Ù…Ø·Ù„Ù‚</option>
                                    <option value="Ø£Ø±Ù…Ù„">Ø£Ø±Ù…Ù„</option>
                                </select>
                            </div>
                            <div class="form-group hidden" id="group-spouse"><label>Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬/Ø§Ù„Ø²ÙˆØ¬Ø©</label><input type="text" id="f_spouse"></div>
                            <div class="form-group hidden" id="group-children"><label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø·ÙØ§Ù„</label><input type="number" id="f_children"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>3. Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø¹Ù…Ù„</h3>
                        <div class="grid-form">
                            <div class="form-group"><label>Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label><input type="text" id="f_education"></div>
                            <div class="form-group"><label>Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label><input type="text" id="f_specialization"></div>
                            <div class="form-group"><label>Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</label><input type="text" id="f_job"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>4. Ø§Ù„Ø³ÙƒÙ† ÙˆØ§Ù„Ø§ØªØµØ§Ù„</h3>
                        <div class="grid-form">
                            <div class="form-group"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" id="f_phone" required></div>
                            <div class="form-group"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©/Ø§Ù„Ù‚Ø¶Ø§Ø¡)</label><input type="text" id="f_address_1"></div>
                            <div class="form-group"><label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ù…Ù†Ø·Ù‚Ø©/Ø¯Ø§Ø±)</label><input type="text" id="f_address_2"></div>
                            <div class="form-group"><label>Ø£Ù‚Ø±Ø¨ Ù†Ù‚Ø·Ø© Ø¯Ø§Ù„Ø©</label><input type="text" id="f_landmark"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>5. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠØ©</h3>
                        <div class="grid-form">
                            <div class="form-group"><label>Ø§Ù„Ù‡ÙŠØ¦Ø©</label><input type="text" id="f_org_body"></div>
                            
                            <div class="form-group">
                                <label>Ø§Ù„ÙØ±Ø¹</label>
                                <select id="f_org_branch">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹...</option>
                                    <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„</option>
                                    <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                                    <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù„Ø«">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                                    <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø¹">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
                                    <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø®Ø§Ù…Ø³">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø®Ø§Ù…Ø³</option>
                                    <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø¯Ø³">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
                                    <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                                </select>
                            </div>

                            <div class="form-group"><label>Ø§Ù„Ø´Ø¹Ø¨Ø©</label><input type="text" id="f_org_div"></div>
                            <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©</label><input type="text" id="f_org_div_name"></div>
                            <div class="form-group"><label>Ø§Ù„ØµÙ†Ù</label><input type="text" id="f_org_class"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>6. Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h3>
                        <div class="grid-form">
                            <div class="form-group"><label>Ø§Ù„Ø®Ø¨Ø±Ø§Øª</label><textarea id="f_skills"></textarea></div>
                            <div class="form-group"><label>Ø§Ù„Ù…Ø¹Ø±Ù</label><input type="text" id="f_ref_name" placeholder="Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"></div>
                            <div class="form-group"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="f_notes"></textarea></div>
                        </div>
                    </div>
                </form>
            </div>

            <div id="tab-db" class="tab-content hidden">
                <div class="table-controls no-print">
                    <input type="text" id="search-input" placeholder="Ø¨Ø­Ø« (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ù‡ÙˆÙŠØ©)..." onkeyup="renderTable()" style="flex: 2; min-width: 200px; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                    
                    <select id="filter-branch" onchange="renderTable()" style="padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                        <option value="">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>
                        <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„</option>
                        <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                        <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù„Ø«">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                        <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø¹">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
                        <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø®Ø§Ù…Ø³">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø®Ø§Ù…Ø³</option>
                        <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø¯Ø³">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
                        <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                    </select>

                    <button onclick="window.print()" class="btn btn-outline">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
                    <button onclick="exportToCSV()" class="btn btn-success admin-only">ØªØµØ¯ÙŠØ± Excel</button>
                </div>
                <div class="table-responsive">
                    <table id="records-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„ÙØ±Ø¹</th> <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>Ø§Ù„Ø¹Ù…Ù„</th>
                                <th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <p id="records-count" style="margin-top: 10px; color: #666;"></p>
            </div>

            <div id="tab-settings" class="tab-content hidden admin-only">
                <div class="form-section">
                    <h3>ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¸Ù‡Ø±</h3>
                    <div class="form-group"><label>Ù„ÙˆÙ† Ø§Ù„Ù†Ø¸Ø§Ù…</label><input type="color" id="set-color" onchange="saveSettings()" style="height: 40px; width: 100%;"></div>
                    <div class="form-group"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="set-title" oninput="saveSettings()"></div>
                </div>

                <div class="form-section">
                    <h3>Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="exportJSON()" class="btn btn-success">ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© (Backup)</button>
                        <label class="btn btn-outline" style="cursor: pointer;">
                            Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©
                            <input type="file" accept=".json" onchange="importJSON(this)" style="display: none;">
                        </label>
                    </div>
                    <hr>
                    <button onclick="wipeData()" class="btn btn-danger">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DB_KEY = 'local_db_v2';
        let appData = {
            settings: { themeColor: '#2563eb', appTitle: 'Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' },
            records: []
        };
        let currentRole = null; // 'ADMIN' or 'VIEWER'

        window.onload = function() {
            loadData();
            applySettings();
            
            // Check session role
            const savedRole = sessionStorage.getItem('app_role');
            if (savedRole) {
                currentRole = savedRole;
                showApp();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        };

        function loadData() {
            const stored = localStorage.getItem(DB_KEY);
            if (stored) {
                appData = JSON.parse(stored);
                if (!appData.records) appData.records = [];
                if (!appData.settings) appData.settings = {};
            }
        }

        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(appData));
        }

        function applySettings() {
            document.documentElement.style.setProperty('--primary', appData.settings.themeColor || '#2563eb');
            const title = appData.settings.appTitle || 'Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
            document.getElementById('app-title').textContent = title;
            document.title = title;
            document.getElementById('set-title').value = title;
            document.getElementById('set-color').value = appData.settings.themeColor;
        }

        // --- Auth Logic ---
        function handleLogin(e) {
            e.preventDefault();
            const code = document.getElementById('login-code').value;
            
            if (code === '110011') {
                currentRole = 'ADMIN';
                sessionStorage.setItem('app_role', 'ADMIN');
                showApp();
            } else if (code === '789') {
                currentRole = 'VIEWER';
                sessionStorage.setItem('app_role', 'VIEWER');
                showApp();
            } else {
                showNotify('Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('app_role');
            currentRole = null;
            location.reload();
        }

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-interface').classList.remove('hidden');
            document.getElementById('user-role-display').textContent = currentRole === 'ADMIN' ? 'Ø§Ù„Ù…Ø¯ÙŠØ±' : 'Ø²Ø§Ø¦Ø±';
            
            // UI Logic based on Role
            const adminElements = document.querySelectorAll('.admin-only');
            if (currentRole === 'VIEWER') {
                adminElements.forEach(el => el.classList.add('hidden'));
                switchTab('tab-db'); // Viewer starts at DB
            } else {
                adminElements.forEach(el => el.classList.remove('hidden'));
                switchTab('tab-form'); // Admin starts at Form
            }
            renderTable();
        }

        // --- Tabs ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if(tabId === 'tab-form') document.getElementById('btn-tab-form').classList.add('active');
            if(tabId === 'tab-db') { document.getElementById('btn-tab-db').classList.add('active'); renderTable(); }
            if(tabId === 'tab-settings') document.getElementById('btn-tab-settings').classList.add('active');
        }

        // --- Form Handling ---
        function toggleMaritalFields() {
            const status = document.getElementById('f_marital').value;
            const isMarried = status === 'Ù…ØªØ²ÙˆØ¬';
            const spouseGroup = document.getElementById('group-spouse');
            const childGroup = document.getElementById('group-children');

            if (isMarried) {
                spouseGroup.classList.remove('hidden');
                childGroup.classList.remove('hidden');
            } else {
                spouseGroup.classList.add('hidden');
                childGroup.classList.add('hidden');
                document.getElementById('f_spouse').value = '';
                document.getElementById('f_children').value = '';
            }
        }

        function resetForm() {
            if(currentRole !== 'ADMIN') return;
            document.getElementById('main-form').reset();
            document.getElementById('f_id').value = '';
            document.getElementById('save-btn').textContent = 'Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„';
            document.getElementById('save-btn').classList.remove('btn-success');
            document.getElementById('save-btn').classList.add('btn-primary');
            toggleMaritalFields();
        }

        function handleSave(e) {
            e.preventDefault();
            if(currentRole !== 'ADMIN') return;

            const idVal = document.getElementById('f_id').value;
            
            const record = {
                id: idVal ? parseInt(idVal) : Date.now(),
                name: document.getElementById('f_name').value,
                dob: document.getElementById('f_dob').value,
                pob: document.getElementById('f_pob').value,
                gender: document.getElementById('f_gender').value,
                mother: document.getElementById('f_mother').value,
                national_id: document.getElementById('f_national_id').value,
                marital: document.getElementById('f_marital').value,
                spouse: document.getElementById('f_spouse').value,
                children: document.getElementById('f_children').value,
                education: document.getElementById('f_education').value,
                specialization: document.getElementById('f_specialization').value,
                job: document.getElementById('f_job').value,
                phone: document.getElementById('f_phone').value,
                address_1: document.getElementById('f_address_1').value,
                address_2: document.getElementById('f_address_2').value,
                landmark: document.getElementById('f_landmark').value,
                org_body: document.getElementById('f_org_body').value,
                org_branch: document.getElementById('f_org_branch').value,
                org_div: document.getElementById('f_org_div').value,
                org_div_name: document.getElementById('f_org_div_name').value,
                org_class: document.getElementById('f_org_class').value,
                skills: document.getElementById('f_skills').value,
                ref_name: document.getElementById('f_ref_name').value,
                notes: document.getElementById('f_notes').value
            };

            if (idVal) {
                const index = appData.records.findIndex(r => r.id == idVal);
                if (index !== -1) { appData.records[index] = record; showNotify('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'success'); }
            } else {
                appData.records.push(record);
                showNotify('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'success');
            }

            saveData();
            resetForm();
        }

        function editRecord(id) {
            if(currentRole !== 'ADMIN') return;
            const rec = appData.records.find(r => r.id == id);
            if (!rec) return;

            resetForm();
            switchTab('tab-form');

            document.getElementById('f_id').value = rec.id;
            document.getElementById('f_name').value = rec.name;
            document.getElementById('f_dob').value = rec.dob;
            document.getElementById('f_pob').value = rec.pob;
            document.getElementById('f_gender').value = rec.gender;
            document.getElementById('f_mother').value = rec.mother;
            document.getElementById('f_national_id').value = rec.national_id;
            document.getElementById('f_marital').value = rec.marital;
            toggleMaritalFields();
            document.getElementById('f_spouse').value = rec.spouse || '';
            document.getElementById('f_children').value = rec.children || '';
            document.getElementById('f_education').value = rec.education;
            document.getElementById('f_specialization').value = rec.specialization;
            document.getElementById('f_job').value = rec.job;
            document.getElementById('f_phone').value = rec.phone;
            document.getElementById('f_address_1').value = rec.address_1;
            document.getElementById('f_address_2').value = rec.address_2;
            document.getElementById('f_landmark').value = rec.landmark;
            document.getElementById('f_org_body').value = rec.org_body;
            document.getElementById('f_org_branch').value = rec.org_branch || '';
            document.getElementById('f_org_div').value = rec.org_div;
            document.getElementById('f_org_div_name').value = rec.org_div_name;
            document.getElementById('f_org_class').value = rec.org_class;
            document.getElementById('f_skills').value = rec.skills;
            document.getElementById('f_ref_name').value = rec.ref_name || '';
            document.getElementById('f_notes').value = rec.notes;

            const btn = document.getElementById('save-btn');
            btn.textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
            btn.classList.replace('btn-primary', 'btn-success');
        }

        function deleteRecord(id) {
            if(currentRole !== 'ADMIN') return;
            if (confirm('Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ')) {
                appData.records = appData.records.filter(r => r.id != id);
                saveData();
                renderTable();
                showNotify('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'error');
            }
        }

        // --- Database & Print ---
        function renderTable() {
            const tbody = document.querySelector('#records-table tbody');
            tbody.innerHTML = '';
            
            const search = document.getElementById('search-input').value.toLowerCase();
            const filterBranch = document.getElementById('filter-branch').value; // Get Branch Filter

            const filtered = appData.records.filter(r => {
                const txt = `${r.name} ${r.phone} ${r.national_id}`.toLowerCase();
                const matchSearch = txt.includes(search);
                // Filter Logic: If filter is selected, check if record's branch matches
                const matchBranch = filterBranch ? (r.org_branch === filterBranch) : true;
                return matchSearch && matchBranch;
            });

            document.getElementById('records-count').textContent = `Ø§Ù„Ø¹Ø¯Ø¯: ${filtered.length}`;

            filtered.forEach((r, idx) => {
                const tr = document.createElement('tr');
                
                // Admin Actions vs Viewer Actions
                let actionsHTML = `<button onclick="printRecord(${r.id})" class="btn btn-outline" style="padding:5px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>`;
                
                if (currentRole === 'ADMIN') {
                    actionsHTML += `
                        <button onclick="editRecord(${r.id})" class="btn btn-primary" style="padding:5px;">âœï¸</button>
                        <button onclick="deleteRecord(${r.id})" class="btn btn-danger" style="padding:5px;">ğŸ—‘ï¸</button>
                    `;
                }

                tr.innerHTML = `
                    <td>${idx + 1}</td>
                    <td><strong>${r.name}</strong></td>
                    <td>${r.org_branch || '-'}</td>
                    <td dir="ltr">${r.phone}</td>
                    <td>${r.job || '-'}</td>
                    <td class="no-print">${actionsHTML}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function printRecord(id) {
            // To print vertically on one page:
            // 1. Populate the Form with the data (readonly mode mentally)
            // 2. Hide everything else via CSS @media print
            // 3. Print
            
            const rec = appData.records.find(d => d.id == id);
            if (!rec) return;

            // Save current form state to restore later if needed, or just clear
            // Populate form fields manually to avoid triggering "Edit Mode" UI changes if Viewer
            document.getElementById('f_name').value = rec.name;
            document.getElementById('f_dob').value = rec.dob;
            document.getElementById('f_pob').value = rec.pob;
            document.getElementById('f_gender').value = rec.gender;
            document.getElementById('f_mother').value = rec.mother;
            document.getElementById('f_national_id').value = rec.national_id;
            document.getElementById('f_marital').value = rec.marital;
            toggleMaritalFields();
            document.getElementById('f_spouse').value = rec.spouse || '';
            document.getElementById('f_children').value = rec.children || '';
            document.getElementById('f_education').value = rec.education;
            document.getElementById('f_specialization').value = rec.specialization;
            document.getElementById('f_job').value = rec.job;
            document.getElementById('f_phone').value = rec.phone;
            document.getElementById('f_address_1').value = rec.address_1;
            document.getElementById('f_address_2').value = rec.address_2;
            document.getElementById('f_landmark').value = rec.landmark;
            document.getElementById('f_org_body').value = rec.org_body;
            document.getElementById('f_org_branch').value = rec.org_branch || '';
            document.getElementById('f_org_div').value = rec.org_div;
            document.getElementById('f_org_div_name').value = rec.org_div_name;
            document.getElementById('f_org_class').value = rec.org_class;
            document.getElementById('f_skills').value = rec.skills;
            document.getElementById('f_ref_name').value = rec.ref_name || '';
            document.getElementById('f_notes').value = rec.notes;

            // Switch to form tab temporarily for printing
            // We use a trick: hide all tab contents, show form, print, then restore
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-form').classList.remove('hidden');
            
            setTimeout(() => {
                window.print();
                // Restore view
                if(currentRole === 'VIEWER') switchTab('tab-db');
                else switchTab('tab-db'); // Return to DB usually makes sense
            }, 300);
        }

        // --- Export/Import (Admin Only) ---
        function exportJSON() {
            if(currentRole !== 'ADMIN') return;
            const str = JSON.stringify(appData, null, 2);
            const blob = new Blob([str], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function importJSON(input) {
            if(currentRole !== 'ADMIN') return;
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    appData = JSON.parse(e.target.result);
                    saveData();
                    loadData();
                    showNotify('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø©', 'success');
                } catch (err) { alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); }
            };
            reader.readAsText(file);
        }

        function exportToCSV() {
            if(currentRole !== 'ADMIN') return;
            let csv = "\uFEFFØ§Ù„Ø§Ø³Ù…,Ø§Ù„ÙØ±Ø¹,Ø§Ù„Ù‡Ø§ØªÙ,Ø§Ù„ØªÙˆÙ„Ø¯,Ø§Ù„Ø¹Ù…Ù„,Ø§Ù„Ø¹Ù†ÙˆØ§Ù†\n";
            appData.records.forEach(r => {
                csv += `"${r.name}","${r.org_branch}","${r.phone}","${r.dob}","${r.job}","${r.address_1}"\n`;
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = "data.csv";
            link.click();
        }

        function wipeData() {
            if(currentRole !== 'ADMIN') return;
            if (confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        }

        function saveSettings() {
            if(currentRole !== 'ADMIN') return;
            appData.settings.themeColor = document.getElementById('set-color').value;
            appData.settings.appTitle = document.getElementById('set-title').value;
            saveData();
            applySettings();
        }

        function showNotify(msg, type) {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.className = type === 'success' ? 'notify-success' : 'notify-error';
            n.style.opacity = '1';
            n.style.bottom = '20px';
            setTimeout(() => { n.style.opacity = '0'; n.style.bottom = '-50px'; }, 3000);
        }
    </script>
</body>
</html>
